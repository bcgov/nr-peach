name: Pull Request

on:
  pull_request:
    branches:
      - main
    types:
      - closed
      - labeled
      - opened
      - reopened
      - synchronize
      - unlabeled

jobs:
  apply:
    name: Deploy Instance
    if: github.event.pull_request.state == 'open' && contains(github.event.pull_request.labels.*.name, 'deploy')
    concurrency:
      group: deploy-pr-${{ github.workflow }}-${{ github.ref_name }}
      cancel-in-progress: false # Do not interrupt terraform deployments
    uses: ./.github/workflows/.instance-deployer.yaml
    permissions:
      contents: write # This is required for actions/checkout
      id-token: write # This is required for requesting the JWT
    secrets: inherit
    with:
      command: apply
      environment: test # TODO: Set default to dev when we have our real environments
      tag: ${{ github.event.pull_request.head.sha }}

  destroy:
    name: Destroy Instance
    if: github.event.pull_request.state == 'closed' || github.event.action == 'unlabeled' && github.event.label.name == 'deploy'
    concurrency:
      group: deploy-pr-${{ github.workflow }}-${{ github.ref_name }}
      cancel-in-progress: false # Do not interrupt terraform deployments
    uses: ./.github/workflows/.instance-deployer.yaml
    permissions:
      contents: write # This is required for actions/checkout
      id-token: write # This is required for requesting the JWT
    secrets: inherit
    with:
      command: destroy
      environment: test # TODO: Set default to dev when we have our real environments
      tag: ${{ github.sha }}
